name: Release Android SDK

on:
  push:
    tags:
      - 'android-v*.*.*'

jobs:
  release:
    name: Build and Publish Android SDK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.COMMIT_ACCESS_TOKEN }}

      - name: Extract version from Git tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#android-v}"
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Extract version from build.gradle.kts
        id: gradle_version
        run: |
          GRADLE_VERSION=$(grep 'val sdkVersion' android-sdk/FlagshipSdk/build.gradle.kts | cut -d'"' -f2)
          echo "GRADLE_VERSION=$GRADLE_VERSION" >> $GITHUB_ENV

      - name: Validate code version is less than tag version
        run: |
          IFS='.' read -ra CODE <<< "$GRADLE_VERSION"
          IFS='.' read -ra TAG <<< "$RELEASE_VERSION"
          for i in 0 1 2; do
            [[ ${CODE[$i]:-0} -lt ${TAG[$i]:-0} ]] && exit 0
            [[ ${CODE[$i]:-0} -gt ${TAG[$i]:-0} ]] && { echo "Code version ($GRADLE_VERSION) must be < tag version ($RELEASE_VERSION)"; exit 1; }
          done
          echo "Code version ($GRADLE_VERSION) must be < tag version ($RELEASE_VERSION)"; exit 1

      - name: Set build.gradle.kts version (without git tag)
        run: |
          sed -i -E "s/val sdkVersion = \"[0-9]+\.[0-9]+\.[0-9]+\"/val sdkVersion = \"$RELEASE_VERSION\"/" android-sdk/FlagshipSdk/build.gradle.kts

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        run: chmod +x ./android-sdk/gradlew

      - name: Create local.properties
        run: |
          cat > android-sdk/local.properties << EOF
          sdk.dir=$ANDROID_HOME
          portalUsername=${{ secrets.SONATYPE_PORTAL_USERNAME }}
          portalPassword=${{ secrets.SONATYPE_PORTAL_PASSWORD }}
          stagingProfileId=${{ secrets.SONATYPE_STAGING_PROFILE_ID }}
          ossrhUsername=${{ secrets.OSSRH_USERNAME }}
          ossrhPassword=${{ secrets.OSSRH_PASSWORD }}
          signing.keyId=${{ secrets.GPG_KEY_ID }}
          signing.key=${{ secrets.GPG_SIGNING_KEY }}
          signing.password=${{ secrets.GPG_SIGNING_PASSWORD }}
          EOF

      - name: Build and Publish to Maven Central
        run: ./gradlew :FlagshipSdk:cleanBuildPublishFlagship --stacktrace
        working-directory: ./android-sdk
        env:
          ORG_GRADLE_PROJECT_signingKeyId: ${{ secrets.GPG_KEY_ID }}
          ORG_GRADLE_PROJECT_signingKey: ${{ secrets.GPG_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.GPG_SIGNING_PASSWORD }}

      - name: Discard version changes and checkout main for bump
        run: |
          git restore android-sdk/FlagshipSdk/build.gradle.kts
          git fetch origin main
          git checkout main
          git pull origin main

      - name: Bump version
        run: |
          chmod +x scripts/bump-version.sh
          ./scripts/bump-version.sh android "$RELEASE_VERSION"
