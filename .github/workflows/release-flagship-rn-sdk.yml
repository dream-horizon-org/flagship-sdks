name: Publish Flagship RN SDK to npm

on:
  push:
    tags:
      - 'rnsdk-v*.*.*' # Triggers on tags like rnsdk-v1.2.3

# Prevent duplicate concurrent runs of the same tag
concurrency:
  group: release-rnsdk-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  publish:
    runs-on: ubuntu-latest
    name: Publish Flagship RN SDK to npm

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: 'https://registry.npmjs.org/'

      - name: Extract version from Git tag (strip leading 'rnsdk-v' if exists)
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#rnsdk-v}" # removes 'rnsdk-v' prefix if present
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Validate version format
        run: |
          if [[ ! "$RELEASE_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version format: $RELEASE_VERSION"
            exit 1
          fi

      - name: Validate code version is less than tag version
        run: |
          CODE_VERSION=$(jq -r .version flagship-rn-sdk/package.json)
          IFS='.' read -ra CODE <<< "$CODE_VERSION"
          IFS='.' read -ra TAG <<< "$RELEASE_VERSION"
          for i in 0 1 2; do
            [[ ${CODE[$i]:-0} -lt ${TAG[$i]:-0} ]] && exit 0
            [[ ${CODE[$i]:-0} -gt ${TAG[$i]:-0} ]] && { echo "Code version ($CODE_VERSION) must be < tag version ($RELEASE_VERSION)"; exit 1; }
          done
          echo "Code version ($CODE_VERSION) must be < tag version ($RELEASE_VERSION)"; exit 1

      - name: Set package.json version (without git tag)
        run: |
          cd flagship-rn-sdk
          npm version --no-git-tag-version "$RELEASE_VERSION"

      - name: Clean old lib (if exists)
        run: |
          cd flagship-rn-sdk
          if [ -d lib ]; then rm -rf lib; fi

      - name: Install dependencies
        run: |
          cd flagship-rn-sdk
          yarn install --immutable

      - name: Build with bob
        run: |
          cd flagship-rn-sdk
          yarn prepare

      - name: Publish to npm
        run: |
          cd flagship-rn-sdk
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Bump version to next SNAPSHOT
        run: |
          chmod +x scripts/bump-version.sh
          ./scripts/bump-version.sh rnsdk "$RELEASE_VERSION"

